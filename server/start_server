#!/bin/bash

# Start the vision server

DIR=/home/odroid/VisionServer/server
SCRIPT=visionserver2018.py
ARGS="--calib ../data/calibration/c930e_calib.json --test"
LOG_FILE="visionserver.log"

setup_camera() {
    # set camera to fixed focus
    # can't be done in cscore
    # NOTE order matters
    uvcdynctrl -d "$1" -s 'Focus, Auto' 0
    echo -n "$1: Focus, Auto = "
    uvcdynctrl -d "$1" -g 'Focus, Auto'

    uvcdynctrl -d "$1" -s 'Focus (absolute)' 0
    echo -n "$1: Focus (absolute) "
    uvcdynctrl -d "$1" -g 'Focus (absolute)'

    # uvcdynctrl -d "$1" -s 'White Balance Temperature, Auto' 0
    # echo -n "$1: White Balance Temperature, Auto "
    # uvcdynctrl -d "$1" -g 'White Balance Temperature, Auto'

    # uvcdynctrl -d "$1" -s 'White Balance Temperature' 2866
    # echo -n "$1: White Balance Temperature "
    # uvcdynctrl -d "$1" -g 'White Balance Temperature'
}

case "$1" in
    stop)
	pkill -f $SCRIPT
	;;

    start)
        cd $DIR
        setup_camera /dev/video0 >> $LOG_FILE 2>&1
        if [ -c /dev/video1 ]; then
            setup_camera /dev/video1 >> $LOG_FILE 2>&1
        fi
        
        python3 ./$SCRIPT $ARGS >> $LOG_FILE 2>&1 < /dev/null &
	;;

    restart)
	$0 stop
	$0 start
	;;

    *)
	echo "$0 (start|stop|restart)"
	;;
esac
